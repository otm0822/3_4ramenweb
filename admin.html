<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ“‹ ì£¼ë¬¸ ë‚´ì—­</title>
  <style>
    body { font-family:sans-serif; padding:1rem; margin:0; }
    h1 { text-align:center; margin-bottom:1rem; }
    #salesSummary { font-weight:bold; margin-bottom:1rem; }
    h2 { margin-top:2rem; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top:0.5rem;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 0.5rem;
      text-align: center;
      font-size:0.9rem;
    }
    button.complete {
      padding: 0.3rem 0.6rem;
      cursor: pointer;
    }
    .btn-back {
      margin-top:2rem;
      padding:0.5rem 1rem;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ ì£¼ë¬¸ ë‚´ì—­</h1>
  <div id="salesSummary">ì´ ë§¤ì¶œ: 0ì›</div>

  <h2>ì§„í–‰ ì¤‘</h2>
  <table id="pendingTable">
    <thead>
      <tr>
        <th>ì‹œê°„</th><th>ë©”ë‰´</th><th>ìˆ˜ëŸ‰</th>
        <th>í† í•‘</th><th>ìˆ˜ë ¹ì¸</th><th>ì£¼ì†Œ</th><th>ì™„ë£Œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>ì™„ë£Œë¨</h2>
  <table id="completedTable">
    <thead>
      <tr>
        <th>ì‹œê°„</th><th>ë©”ë‰´</th><th>ìˆ˜ëŸ‰</th>
        <th>í† í•‘</th><th>ìˆ˜ë ¹ì¸</th><th>ì£¼ì†Œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="btn-back" onclick="location.href='/'">â† ì£¼ë¬¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

  <script>
    const menu = {
      "ê¸°ë³¸ ë¼ë©´":4000,
      "ì¹˜ì¦ˆ ë¼ë©´":4500,
      "ë–¡ ë¼ë©´":4500,
      "ë§Œë‘ ë¼ë©´":4500,
      "ëœë¤ ë¼ë©´":4300,
      "í–‡ë°˜":1500
    };
    const toppingPrices = { ê³„ë€:700, íŒŒ:700, ê¹€ì¹˜:700 };

    async function loadAdmin() {
      const res = await fetch("/api/orders");
      const os  = await res.json();

      // ë¶„ë¦¬
      const pending   = os.filter(o=>!o.completed);
      const completed = os.filter(o=>o.completed);

      // ë§¤ì¶œ ê³„ì‚°
      let totalSales = 0;
      completed.forEach(o=>{
        const base = menu[o.item]||0;
        const tSum = o.toppings.reduce((sum,t)=>sum + (toppingPrices[t]||0), 0);
        totalSales += (base + tSum) * o.quantity;
      });
      document.getElementById("salesSummary").textContent =
        `ì´ ë§¤ì¶œ: ${totalSales.toLocaleString()}ì›`;

      // ì§„í–‰ì¤‘ ë Œë”
      const pTbody = document.querySelector("#pendingTable tbody");
      pTbody.innerHTML = pending.map(o=>`
        <tr>
          <td>${o.timestamp}</td>
          <td>${o.item}</td>
          <td>${o.quantity}</td>
          <td>${o.toppings.join(",")}</td>
          <td>${o.deliverer}</td>
          <td>${o.address}</td>
          <td><button class="complete" data-id="${o.id}">ì™„ë£Œ</button></td>
        </tr>
      `).join("");

      // ì™„ë£Œ ë Œë”
      const cTbody = document.querySelector("#completedTable tbody");
      cTbody.innerHTML = completed.map(o=>`
        <tr>
          <td>${o.timestamp}</td>
          <td>${o.item}</td>
          <td>${o.quantity}</td>
          <td>${o.toppings.join(",")}</td>
          <td>${o.deliverer}</td>
          <td>${o.address}</td>
        </tr>
      `).join("");

      // ì™„ë£Œ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.querySelectorAll(".complete").forEach(btn=>{
        btn.onclick = async () => {
          await fetch(`/api/orders/${btn.dataset.id}/complete`, { method:"POST" });
          loadAdmin();
        };
      });
    }

    // ì´ˆê¸° ë¡œë“œ
    loadAdmin();
  </script>
</body>
</html>
